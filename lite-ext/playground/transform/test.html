
<!DOCTYPE HTML>
<html>
<head>
    <!-- ie8 is not ok <absolute transform><absolute>wrong</absolute></absolute> -->
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
    <meta charset="utf-8">
</head>
<body>
    <div style='position:absolute;left:100px;top:100px;'>
        <div style='width:20px;height:100px;background:red;position:absolute;margin-top:0;margin-left:0;' id='t'>
            <div style='background:blue;width:20px;height:20px;position:absolute;bottom:0;cursor:move;' id='t2'>
                
            </div>
        </div>
        <!--
        <div style='width:20px;height:100px;background:green;position:absolute;'>
        </div>
        -->
        
        <div style='width:100px;height:100px;border:1px solid green;position:absolute;left:200px;top:200px;' id='c'></div>
    </div>
<script src='http://a.tbcdn.cn/s/kissy/1.2.0/kissy-min.js'></script>
<script>
    var S=KISSY,ua=KISSY.UA,DOM=S.DOM,Event=S.Event;
    
    function generateMatrix(angle){
        var m=[[],[]];
        var rad = angle * (Math.PI / 180),
            m11 = Math.cos(rad),  
            m12 = -1 * Math.sin(rad),  
            m21 = Math.sin(rad),  
            m22 = m11;  
        return [[m11,m12],[m21,m22]];    
    }
    
    var prefix=["Ms","Webkit","Moz","O",""];
    
    var d=DOM.get("#t"),
        orig={
            height:d.offsetHeight,
            width:d.offsetWidth,
            marginTop:parseInt(DOM.css(d,"marginTop")),
            marginLeft:parseInt(DOM.css(d,"marginLeft"))
        };
    
    function rotate(d,angle){
        var style=d.style;
         var rad = angle * (Math.PI / 180);
         var matrix=generateMatrix(angle);
        if(ua.ie&&ua.ie<9){
            style.filter='progid:DXImageTransform.Microsoft.Matrix(M11=' + matrix[0][0] + ',M12=' + matrix[0][1] + ',M21=' 
            + matrix[1][0] + ',M22=' + matrix[1][1] + ',SizingMethod="auto expand")';
            //style.marginTop = (orig.height-d.offsetHeight) /2;
            //style.marginLeft = (orig.width-d.offsetWidth) /2;
            setXy(0.5,0,matrix);
        }else{           
            S.each(prefix,function(p){
                 style[p+"Transform"]="rotate("+angle+"deg)";
            });
        }
    }
    
    
    function multiple(m1,m2){
        
        m=[];
        
        function set(x,y,v){
            if(!m[x]){m[x]=[];}
            m[x][y]=v;
        }
        
        var r1=m1.length,
            c1=m1[0].length,
            r2=m2.length,
            c2=m2[0].length;
            
        for(var i=0;i<r1;i++){
            
            for(var k=0;k<c2;k++){
                var sum=0;
                for(var j=0;j<r2;j++){
                    sum+=m1[i][j]*m2[j][k];
                }
                
                set(i,k,sum);
            }
        }   
        
        return m; 
        
    }
    
    function setXy(px,py,m){
        var centerX=orig.width/2,
        centerY=orig.height/2;
       
        var originX=px*orig.width,
        originY=py*orig.height;
       
        var diffX=centerX-originX,
        diffY=centerY-originY;
       
        var transformed=multiple(m,[[diffX],[diffY]]),
            transformedX= transformed[0][0]+originX,
            transformedY=transformed[1][0]+originY;
        
        var diff=[transformedX-d.offsetWidth/2,transformedY-d.offsetHeight/2];
        
        DOM.css(d,{
            marginTop:orig.marginTop+diff[1],
            marginLeft:orig.marginTop+diff[0]
        });            
    }
  
    var deg=0,
        dragging=0,
        t2=DOM.get("#t2"),
        stop=0,
        deta=1;
        S.each(prefix,function(p){
            S.one("#t").css(p+"TransformOrigin","50% 0");
        });
    var anim = setInterval(function(){
        if(stop){
            return;
        }
        if(deg>60){
          deta=-1;
        }
        else if(deg<-60){
            deta=1;
        }
        deg+=deta; 
        rotate(DOM.get("#t"),deg);
    },30);
    
    
    Event.on(t2,"mouseenter",function(){
        stop=1;
    });
    
    Event.on(t2,"mouseleave",function(){
        if(dragging){
            stop=1;
        }else{
            stop=0;
        }
    });
    
    Event.on(t2,"mousedown",function(e){
        DOM.css(document.body,{
            cursor:"move"
        });
        dragging=1;
        e.preventDefault();
    });
    
    Event.on(document,"mousemove",function(e){
        if(dragging){         
            if(t2.parentNode!==document.body){
                document.body.appendChild(t2);
            }   
            DOM.offset(t2,{
                left:e.pageX,
                top:e.pageY
            }); 
        }
    });
    
    function getRegion(t){
        var xy=DOM.offset(t);
        xy.bottom=xy.top+t.offsetHeight;
        xy.right=xy.left+t.offsetWidth;
        return xy;
    }
    
    function inRegion(t2,container){
        var r2=getRegion(t2),
            c=getRegion(container);
            if(r2.left>=c.left&&r2.right<=c.right&&r2.bottom<=c.bottom&&r2.top>=c.top){
                return 1;
            }
            return 0;
    }
    
    
    Event.on(document,"mouseup",function(e){
        dragging=0;  
        if(inRegion(t2,DOM.get("#c"))){
            DOM.get("#c").appendChild(t2);
            t2.style.position="static";
            t2.style.cursor="";
            clearInterval(anim);
            Event.remove(t2);
        }else{            
            DOM.get("#t").appendChild(t2); 
            DOM.css(t2,"bottom","0");
            DOM.css(t2,"left","");
            DOM.css(t2,"top","");
            stop=0;
            DOM.css(document.body,{
                cursor:""
            });
        }
    });
    
    
</script>
</body>
</html>